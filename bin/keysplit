#!/bin/bash
# Author: Vivek Myers
# Date: 2024-08-28

name="$(basename ${1%.key})"
outdir="$(readlink -f ${2-$name})"
src="$(readlink -f "$1")"
srcdir="$(dirname "$src")"

read -d '' -r script << 'EOF'
on sansExt(theFileName)
do shell script "file=" & theFileName & ";" & "echo ${file%.*}"
end sansExt

on getExt(theFileName)
do shell script "file=" & theFileName & ";" & "echo ${file##*.}"
end getExt

on run argv
  set keynote_path to (item 1 of argv)
  set out_path to (item 2 of argv)
  set extension to getExt(out_path)
  set basename to sansExt(out_path)

  tell application "Keynote"
    set keynote_file to open (keynote_path as POSIX file)
    if extension is equal to "pdf" then
      export keynote_file to (out_path as POSIX file) as PDF
      close keynote_file saving no
  else if extension is equal to "jpeg" then
      export keynote_file to (basename as POSIX file) as slide images with properties { compression factor: 1.0, image format: JPEG }
      close keynote_file saving no
  else
  do shell script "echo Output format " & extension & " not supported."
  end
end tell
end run
EOF

rm -f "$outdir/$name.pdf"
mkdir -p "$outdir" 2>/dev/null
osascript -e "$script" "$src" "$outdir/$name.pdf" || exit 1
rm -f "$outdir"/slide*.pdf
pdfseparate "$outdir/$name.pdf" "$outdir/slide%d.pdf"
for i in "$outdir"/slide*.pdf; do
    pdfcrop "$i" "$i" &
done
wait
rm -f "$outdir/$name.pdf"


